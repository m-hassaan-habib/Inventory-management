{% extends "base.html" %}
{% block content %}
<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
  <h2 class="text-2xl font-extrabold text-indigo-900 flex items-center gap-2 dark:text-white">
    <i class="fas fa-building text-indigo-600 text-xl"></i> Vendors
  </h2>
  <button
    onclick="openVendorModal()"
    type="button"
    class="inline-flex items-center gap-2 bg-indigo-700 hover:bg-indigo-800 text-white text-sm font-semibold rounded-lg px-4 py-2 mt-4 sm:mt-0"
  >
    <i class="fas fa-plus"></i> Add Vendor
  </button>
</div>

<p class="text-gray-600 mb-6 dark:text-white/60">Manage your vendor database</p>

<form class="mb-6" onsubmit="return false;">
  <label for="search" class="sr-only">Search vendors</label>
  <div
    class="flex items-center rounded-lg px-4 py-2 text-sm focus-within:ring-2 focus-within:ring-indigo-600
           border border-gray-300 text-gray-600 bg-white
           dark:border-white/10 dark:text-white/70 dark:bg-[#202020]"
  >
    <i class="fas fa-search mr-2 text-gray-500 dark:text-white/50"></i>
    <input
      id="search"
      type="search"
      placeholder="Search vendors..."
      class="w-full bg-transparent outline-none placeholder:text-gray-400 dark:placeholder:text-white/35"
    />
  </div>
</form>

<div class="rounded-lg overflow-hidden text-sm
            border border-gray-300
            dark:border-white/10">
  <div class="p-6 bg-white dark:bg-[#202020]">
    <h3 class="font-extrabold text-gray-900 mb-4 text-lg dark:text-white">
      All Vendors ({{ vendors|length }})
    </h3>

    <div class="overflow-x-auto">
      <table class="w-full border-separate border-spacing-y-3" id="vendor-table">
        <thead class="text-xs font-normal sticky top-0 z-10
                      text-gray-500 bg-white
                      dark:text-white/45 dark:bg-[#202020]">
          <tr>
            <th class="text-left pl-4 pr-2 py-2 w-1/6 min-w-[120px] sticky left-0 bg-white dark:bg-[#202020]">Name</th>
            <th class="text-left px-2 py-2 w-1/6 min-w-[150px]">Contact</th>
            <th class="text-left px-2 py-2 w-1/4 min-w-[200px]">Address</th>
            <th class="text-left px-2 py-2 w-1/12 min-w-[80px]">Invoices</th>
            <th class="text-left px-2 py-2 w-1/12 min-w-[100px]">Total Amount</th>
            <th class="text-left pr-4 py-2 w-1/12 min-w-[100px]">Actions</th>
          </tr>
        </thead>

        <tbody id="vendor-tbody">
          {% for v in vendors %}
          <tr class="transition duration-100 ease-in-out hover:-translate-y-1 hover:shadow-md
                     {% if loop.index % 2 == 0 %}bg-gray-100{% else %}bg-white{% endif %}
                     dark:bg-[#202020] dark:hover:bg-white/5">
            <td class="pl-4 pr-2 py-3 align-top w-1/6 min-w-[120px] sticky left-0 bg-inherit
                       text-gray-900 dark:text-white">
              {{ v.name }}
            </td>

            <td class="px-2 py-3 align-top w-1/6 min-w-[150px] space-y-2
                       text-gray-700 dark:text-white/75">
              {% if v.phones %}
                {% for phone in v.phones.split(',') %}
                  <div class="flex items-center gap-1">
                    <i class="fas fa-phone-alt text-xs text-gray-500 dark:text-white/50"></i>
                    <span class="font-semibold text-gray-900 text-xs dark:text-white/85">{{ phone.strip() }}</span>
                  </div>
                {% endfor %}
              {% endif %}
              {% if v.email %}
                <div class="flex items-center gap-1 mt-1">
                  <i class="fas fa-envelope text-xs text-gray-500 dark:text-white/50"></i>
                  <span class="text-xs">{{ v.email }}</span>
                </div>
              {% endif %}
            </td>

            <td class="px-2 py-3 align-top w-1/4 min-w-[200px] text-xs
                       text-gray-900 dark:text-white/85">
              {{ v.address }}
            </td>

            <td class="px-2 py-3 align-top w-1/12 min-w-[80px] text-center">
              <span class="inline-block font-semibold text-xs rounded-full px-2 py-1
                           bg-gray-200 text-gray-900
                           dark:bg-white/10 dark:text-white/85">
                {{ v.invoice_count }}
              </span>
            </td>

            <td class="px-2 py-3 align-top w-1/12 min-w-[100px] text-xs
                       text-gray-900 dark:text-white/85">
              Rs.{{ v.total_amount }}
            </td>

            <td class="pr-4 py-3 align-top w-1/12 min-w-[100px] space-x-2 whitespace-nowrap">
              <button
                type="button"
                onclick='openVendorModal(true, {{ v|tojson }})'
                class="rounded-md p-2 transition duration-200 hover:scale-110
                       border border-gray-300 text-gray-700 hover:bg-gray-100
                       dark:border-white/10 dark:text-white/75 dark:hover:bg-white/5"
                aria-label="Edit {{ v.name }}"
              >
                <i class="fas fa-edit text-xs"></i>
              </button>
              <button
                type="button"
                onclick='openDeleteVendorModal({{ v.id }})'
                class="rounded-md p-2 transition duration-200 hover:scale-110
                       border border-gray-300 text-gray-700 hover:bg-gray-100
                       dark:border-white/10 dark:text-white/75 dark:hover:bg-white/5"
                aria-label="Delete {{ v.name }}"
              >
                <i class="fas fa-trash-alt text-xs"></i>
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="flex flex-col sm:flex-row justify-between items-center mt-4 px-6">
  <div class="text-sm text-gray-600 mb-2 sm:mb-0 dark:text-white/60">
    Showing <span id="page-info">1-10</span> of {{ vendors|length }} vendors
  </div>
  <div class="flex space-x-2">
    <button
      id="prev-page"
      class="rounded-md px-3 py-1 text-sm disabled:opacity-50
             border border-gray-300 text-gray-700 hover:bg-gray-100
             dark:border-white/10 dark:text-white/75 dark:hover:bg-white/5"
      disabled
    >
      Previous
    </button>
    <button
      id="next-page"
      class="rounded-md px-3 py-1 text-sm
             border border-gray-300 text-gray-700 hover:bg-gray-100
             dark:border-white/10 dark:text-white/75 dark:hover:bg-white/5"
    >
      Next
    </button>
  </div>
</div>

<script>
  const vendorsPerPage = 10;
  let currentPage = 1;
  const tbody = document.getElementById('vendor-tbody');
  const allRows = Array.from(tbody.getElementsByTagName('tr'));
  let filteredRows = [...allRows];
  const prevButton = document.getElementById('prev-page');
  const nextButton = document.getElementById('next-page');
  const pageInfo = document.getElementById('page-info');

  function filterVendors() {
    const searchTerm = document.getElementById('search').value.toLowerCase();
    filteredRows = allRows.filter(row => row.innerText.toLowerCase().includes(searchTerm));
    currentPage = 1;
    updatePagination();
  }

  function updatePagination() {
    allRows.forEach(row => row.style.display = 'none');

    const totalFiltered = filteredRows.length;
    const totalPages = Math.max(1, Math.ceil(totalFiltered / vendorsPerPage));

    const start = (currentPage - 1) * vendorsPerPage;
    const end = Math.min(start + vendorsPerPage, totalFiltered);

    for (let i = start; i < end; i++) filteredRows[i].style.display = '';

    pageInfo.textContent = `${start + 1}-${end} of ${totalFiltered}`;

    prevButton.disabled = currentPage === 1;
    nextButton.disabled = currentPage >= totalPages;
  }

  prevButton.addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      updatePagination();
    }
  });

  nextButton.addEventListener('click', () => {
    const totalPages = Math.max(1, Math.ceil(filteredRows.length / vendorsPerPage));
    if (currentPage < totalPages) {
      currentPage++;
      updatePagination();
    }
  });

  document.getElementById('search').addEventListener('input', filterVendors);
  updatePagination();
</script>

{% include "modals/add_vendor.html" %}
{% include "modals/delete_vendor.html" %}
{% endblock %}
