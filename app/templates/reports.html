{% extends "base.html" %}
{% block content %}
<section class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
  <div>
    <h3 class="text-xl font-extrabold text-slate-900 flex items-center space-x-2 dark:text-white">
      <i class="fas fa-chart-bar text-indigo-600 text-lg"></i>
      <span>Reports</span>
    </h3>
    <p class="text-xs text-slate-400 mt-1 dark:text-white/50">Invoice analytics and reporting</p>
  </div>
</section>

<section class="rounded-lg p-4 space-y-4 mt-4
                border border-slate-200 bg-white
                dark:border-white/10 dark:bg-[#202020]">
  <h4 class="font-semibold text-slate-900 flex items-center space-x-2 text-sm dark:text-white">
    <i class="fas fa-filter text-slate-600 dark:text-white/60"></i>
    <span>Report Filters</span>
  </h4>

  <div class="flex flex-wrap gap-2 text-xs text-slate-700 dark:text-white/70" id="quick-filters">
    <span data-range="today" class="filter-btn px-2 py-1 rounded-md border border-slate-300 cursor-pointer hover:bg-indigo-600 hover:text-white dark:border-white/10 dark:hover:bg-indigo-600">Today</span>
    <span data-range="7" class="filter-btn px-2 py-1 rounded-md border border-slate-300 cursor-pointer hover:bg-indigo-600 hover:text-white dark:border-white/10 dark:hover:bg-indigo-600">Last 7 Days</span>
    <span data-range="15" class="filter-btn px-2 py-1 rounded-md border border-slate-300 cursor-pointer hover:bg-indigo-600 hover:text-white dark:border-white/10 dark:hover:bg-indigo-600">Last 15 Days</span>
    <span data-range="30" class="filter-btn px-2 py-1 rounded-md border border-slate-300 cursor-pointer hover:bg-indigo-600 hover:text-white dark:border-white/10 dark:hover:bg-indigo-600">Last 30 Days</span>
    <span data-range="month" class="filter-btn px-2 py-1 rounded-md border border-slate-300 cursor-pointer hover:bg-indigo-600 hover:text-white dark:border-white/10 dark:hover:bg-indigo-600">This Month</span>
    <span data-range="year" class="filter-btn px-2 py-1 rounded-md border border-slate-300 cursor-pointer hover:bg-indigo-600 hover:text-white dark:border-white/10 dark:hover:bg-indigo-600">This Year</span>
  </div>

  <form method="get" id="report-filters" class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-xs text-slate-700 dark:text-white/70">
    <label class="flex flex-col space-y-1">
      <span>From Date</span>
      <input type="date" name="from" value="{{ request.args.get('from','') }}"
             class="w-full rounded-md px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-indigo-600
                    border border-slate-300 text-slate-900 bg-white
                    dark:border-white/10 dark:text-white/85 dark:bg-[#161616]"
             onchange="this.form.submit()">
    </label>
    <label class="flex flex-col space-y-1">
      <span>To Date</span>
      <input type="date" name="to" value="{{ request.args.get('to','') }}"
             class="w-full rounded-md px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-indigo-600
                    border border-slate-300 text-slate-900 bg-white
                    dark:border-white/10 dark:text-white/85 dark:bg-[#161616]"
             onchange="this.form.submit()">
    </label>
    <label class="flex flex-col space-y-1">
      <span>Vendor</span>
      <select name="vendor_id"
              class="w-full rounded-md px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-indigo-600
                     border border-slate-300 text-slate-900 bg-white
                     dark:border-white/10 dark:text-white/85 dark:bg-[#161616]"
              onchange="this.form.submit()">
        <option value="" {% if not request.args.get('vendor_id') %}selected{% endif %}>All Vendors</option>
        {% for v in vendors %}
          <option value="{{ v.id }}" {% if request.args.get('vendor_id') == v.id|string %}selected{% endif %}>
            {{ v.name }}
          </option>
        {% endfor %}
      </select>
    </label>
  </form>
</section>

<section class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-4">
  <div class="rounded-lg p-4 text-xs relative transition transform hover:scale-[1.02] hover:shadow-lg duration-100
              border border-slate-200 bg-white text-slate-700 hover:border-indigo-200
              dark:border-white/10 dark:bg-[#202020] dark:text-white/70 dark:hover:border-indigo-500/30">
    <span class="block mb-2">Total Invoices</span>
    <p class="font-bold text-slate-900 text-lg mb-1 dark:text-white">{{ summary.total_invoices }}</p>
    <p class="text-[10px] text-slate-400 dark:text-white/45">In selected period</p>
    <i class="fas fa-file-invoice-dollar absolute top-4 right-4 text-slate-300 text-xs dark:text-white/15"></i>
  </div>

  <div class="rounded-lg p-4 text-xs relative transition transform hover:scale-[1.02] hover:shadow-lg duration-100
              border border-slate-200 bg-white text-slate-700 hover:border-indigo-200
              dark:border-white/10 dark:bg-[#202020] dark:text-white/70 dark:hover:border-indigo-500/30">
    <span class="block mb-2">Total Expenses</span>
    <p class="font-bold text-green-600 text-lg mb-1 dark:text-green-300">Rs.{{ summary.total_revenue }}</p>
    <p class="text-[10px] text-slate-400 dark:text-white/45">Gross expenses</p>
    <span class="absolute top-4 right-4 text-green-500 text-xs dark:text-green-300">$</span>
  </div>

  <div class="rounded-lg p-4 text-xs relative transition transform hover:scale-[1.02] hover:shadow-lg duration-100
              border border-slate-200 bg-white text-slate-700 hover:border-indigo-200
              dark:border-white/10 dark:bg-[#202020] dark:text-white/70 dark:hover:border-indigo-500/30">
    <span class="block mb-2">Total Items Purchased</span>
    <p class="font-bold text-orange-500 text-lg mb-1 dark:text-yellow-300">{{ summary.total_items }}</p>
    <p class="text-[10px] text-slate-400 dark:text-white/45">Total quantity across all invoices</p>
    <i class="fas fa-cube absolute top-4 right-4 text-orange-400 text-xs dark:text-yellow-300/70"></i>
  </div>
</section>

<section class="rounded-lg p-4 text-xs overflow-x-auto mt-6
                border border-slate-200 bg-white text-slate-700
                dark:border-white/10 dark:bg-[#202020] dark:text-white/70">
  <h4 class="font-semibold text-slate-900 mb-4 dark:text-white">
    Invoice Details ({{ invoices|length }} invoices)
  </h4>

  <table class="w-full border-collapse min-w-[600px]">
    <thead>
      <tr class="border-b border-slate-200 text-left text-[11px] text-slate-400 dark:border-white/10 dark:text-white/45">
        <th class="py-2 px-3">Invoice #</th>
        <th class="py-2 px-3">Vendor</th>
        <th class="py-2 px-3">Date</th>
        <th class="py-2 px-3">Status</th>
        <th class="py-2 px-3">Items</th>
        <th class="py-2 px-3">Amount</th>
      </tr>
    </thead>

    <tbody id="reports-tbody" class="text-[12px] text-slate-900 dark:text-white/85">
      {% for inv in invoices %}
      <tr class="border-b border-slate-100 transition duration-100 ease-in-out hover:-translate-y-1 hover:shadow-md
                 hover:bg-indigo-50 dark:border-white/5 dark:hover:bg-white/5">
        <td class="py-3 px-3 font-semibold whitespace-nowrap">{{ inv.invoice_number }}</td>
        <td class="py-3 px-3">{{ inv.vendor_name }}</td>
        <td class="py-3 px-3 whitespace-nowrap">{{ inv.invoice_date }}</td>
        <td class="py-3 px-3">
          <span class="inline-block text-[10px] font-semibold px-2 py-0.5 rounded-full select-none
            {% if inv.status|lower == 'paid' %}
              bg-green-100 text-green-600 dark:bg-green-500/15 dark:text-green-300
            {% elif inv.status|lower == 'pending' %}
              bg-orange-100 text-orange-500 dark:bg-yellow-500/15 dark:text-yellow-300
            {% elif inv.status|lower == 'overdue' %}
              bg-red-100 text-red-400 dark:bg-red-500/15 dark:text-red-300
            {% endif %}
          ">{{ inv.status }}</span>
        </td>
        <td class="py-3 px-3 font-semibold">{{ inv.total_items }} items</td>
        <td class="py-3 px-3 whitespace-nowrap">Rs.{{ inv.total }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<div id="pagination" class="flex justify-center items-center gap-2 mt-6">
  <button onclick="prevPage()" disabled
          class="px-4 py-2 rounded-md text-sm border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50
                 dark:border-white/10 dark:text-white/75 dark:bg-[#202020] dark:hover:bg-white/5">
    Previous
  </button>
  <span id="page-info" class="text-slate-700 dark:text-white/70">Page 1 of 1</span>
  <button onclick="nextPage()" disabled
          class="px-4 py-2 rounded-md text-sm border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50
                 dark:border-white/10 dark:text-white/75 dark:bg-[#202020] dark:hover:bg-white/5">
    Next
  </button>
</div>

<script>
function applyHighlight(btn) {
  document.querySelectorAll('#quick-filters .filter-btn').forEach(el => {
    el.classList.remove('bg-indigo-600','text-white');
    el.classList.add('border','border-slate-300','text-slate-700');
    el.classList.add('dark:border-white/10');
    el.classList.add('dark:text-white/70');
  });
  btn.classList.add('bg-indigo-600','text-white');
  btn.classList.remove('border','border-slate-300','text-slate-700');
  btn.classList.remove('dark:border-white/10');
  btn.classList.remove('dark:text-white/70');
}

document.querySelectorAll('#quick-filters .filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const range = btn.getAttribute('data-range');
    const url = new URL(window.location.href);
    url.searchParams.set('range', range);
    url.searchParams.delete('from');
    url.searchParams.delete('to');
    window.location.href = url.toString();
  });
});

window.addEventListener('DOMContentLoaded', () => {
  const params = new URLSearchParams(window.location.search);
  const range = params.get('range');
  if (range) {
    const active = document.querySelector(`[data-range="${range}"]`);
    if (active) applyHighlight(active);
  }

  const rows = document.querySelectorAll('#reports-tbody tr');
  const perPage = 10;
  let currentPage = 1;

  function showPage(page) {
    const start = (page - 1) * perPage;
    const end = start + perPage;
    rows.forEach((r, i) => {
      r.style.display = (i >= start && i < end) ? '' : 'none';
    });
    document.getElementById('page-info').textContent = `Page ${page} of ${Math.ceil(rows.length / perPage)}`;
    document.querySelector('button[onclick="prevPage()"]').disabled = page === 1;
    document.querySelector('button[onclick="nextPage()"]').disabled = page >= Math.ceil(rows.length / perPage);
  }

  window.prevPage = function() {
    if (currentPage > 1) {
      currentPage--;
      showPage(currentPage);
    }
  };

  window.nextPage = function() {
    const totalPages = Math.ceil(rows.length / perPage);
    if (currentPage < totalPages) {
      currentPage++;
      showPage(currentPage);
    }
  };

  showPage(1);
});
</script>
{% endblock %}
